<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Love Heart Planet 3D ‚ù§Ô∏è</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body {
        margin: 0;
        overflow: hidden;
        background: radial-gradient(circle at center, #1a002a, #000);
        font-family: "Segoe UI", sans-serif;
    }

    /* ==== CENTER INFO ==== */
    #centerInfo {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
        pointer-events: none;
    }

    #centerInfo .row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 60px;
    }

    .person {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .person img {
        width: 95px;
        height: 95px;
        object-fit: cover;
        border-radius: 20px;
        box-shadow: 0 0 20px #ff99dd;
    }

    .name {
        margin-top: 6px;
        font-size: 17px;
        color: white;
        text-shadow: 0 0 10px #fff;
    }

    #dayCount {
        font-size: 38px;
        font-weight: bold;
        color: white;
        text-shadow: 0 0 15px #ff88cc;
    }

    .quote {
        font-size: 14px;
        color: #eee;
        margin-top: 8px;
    }

    /* ==== ADD BUTTON ==== */
    #addBtn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #ff4d79;
        padding: 12px 18px;
        border-radius: 12px;
        color: white;
        border: none;
        font-size: 16px;
        z-index: 10;
        cursor: pointer;
    }

    /* ============ POPUP ============ */
    #popup, #addPopup {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 20;
        pointer-events: auto;
    }

    #popup-box {
        position: relative;
        width: 460px;
        background: #fff;
        padding: 28px;
        border-radius: 14px;
        animation: openLetter 0.35s ease-out;
        pointer-events: auto;
    }

    /* OPEN LETTER ANIMATION */
    @keyframes openLetter {
        0% { transform: scale(0.5) translateY(40px); opacity: 0; }
        70% { transform: scale(1.05) translateY(0); opacity: 1; }
        100% { transform: scale(1); }
    }

    /* Close Button (X) */
    .close-btn {
        position: absolute;
        top: -12px;
        right: -12px;
        background: #ff4d6d;
        color: white;
        width: 34px;
        height: 34px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 20px;
        border-radius: 50%;
        border: 2px solid white;
        cursor: pointer;
        z-index: 9999;
        transition: 0.15s;
        box-shadow: 0 0 10px #ff85a0;
    }
    .close-btn:hover {
        background: #ff234e;
        transform: scale(1.1);
    }

    /* ============ ADD POPUP ============ */
    #addBox {
        background: #fff;
        padding: 20px;
        border-radius: 14px;
        width: 350px;
        animation: pop .25s ease;
    }

    @keyframes pop {
        from { transform: scale(0.6); opacity: 0; }
        to   { transform: scale(1);   opacity: 1; }
    }

    #addBox textarea,
    #addBox input {
        width: 100%;
        padding: 8px;
        margin-top: 6px;
        border-radius: 6px;
        border: 1px solid #aaa;
    }

    .mood-row {
        display: flex;
        gap: 12px;
        margin-top: 10px;
    }

    .mood-chip {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }

    /* ===== NOTE LETTER ===== */
    .note-letter {
        display: flex;
        gap: 18px;
    }

    .note-img {
        width: 165px;
        height: 165px;
        object-fit: cover;
        border-radius: 14px;
        box-shadow: 0 0 10px rgba(255,255,255,0.6);
    }

    .note-paper {
        flex: 1;
        padding: 18px;
        border-radius: 12px;
        white-space: pre-wrap;
        font-size: 18px;
    }

    /* Mood colors */
    .note-paper.vui {
        background: #ffe4f2;
        border: 1px solid #ffb5d6;
        box-shadow: 0 0 12px #ffbadc;
    }

    .note-paper.buon {
        background: #e2f1ff;
        border: 1px solid #9ecfff;
        box-shadow: 0 0 12px #b5ddff;
    }

    .center-note {
        text-align: center;
    }
</style>
</head>

<body>

<canvas id="canvas" style="pointer-events:none;"></canvas>

<!-- ==== CENTER INFO ==== -->
<div id="centerInfo">
    <div class="row">
        <div class="person">
            <img src="me.jpg">
            <div class="name">Th√≠u K·ªãt</div>
        </div>

        <div class="middle">
            <div id="dayCount">0 ng√†y</div>
            <div class="quote">T·ª•i m√¨nh c·ªë g·∫Øng v√¨ nhau em nh√© üíñ</div>
        </div>

        <div class="person">
            <img src="cucdang.jpg">
            <div class="name">H·∫≠u H·∫≠u</div>
        </div>
    </div>
</div>

<button id="addBtn">+ Th√™m k·ª∑ ni·ªám</button>

<!-- ==== NOTE POPUP ==== -->
<div id="popup">
    <div id="popup-box">
        <div id="popup-content"></div>
        <div class="close-btn" onclick="popup.style.display='none'">√ó</div>
    </div>
</div>

<!-- ==== ADD POPUP ==== -->
<div id="addPopup">
    <div id="addBox">
        <h3>Th√™m k·ª∑ ni·ªám üíõ</h3>

        <textarea id="noteText" placeholder="Nh·∫≠p n·ªôi dung..." rows="3"></textarea>
        <input type="file" id="noteImg" accept="image/*">

        <div class="mood-row">
            <label><input type="radio" name="mood" value="vui" checked>
                <span class="mood-chip" style="background:#ff4d6d"></span> Vui
            </label>
            <label><input type="radio" name="mood" value="buon">
                <span class="mood-chip" style="background:#4da6ff"></span> Bu·ªìn
            </label>
        </div>

        <button onclick="addNote()"
            style="margin-top:12px;padding:10px 12px;background:#2b1055;color:white;border:none;border-radius:8px;">
            Ghim
        </button>

        <button onclick="addPopup.style.display='none'"
            style="margin-top:6px;padding:8px;background:#ccc;border:none;border-radius:8px;">
            H·ªßy
        </button>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>

/* ================================
   NG√ÄY Y√äU
================================ */
const startDate = new Date("2025-10-26");
function updateDays() {
    let days = Math.floor((new Date() - startDate) / 86400000);
    document.getElementById("dayCount").innerText = days + " ng√†y";
}
updateDays();
setInterval(updateDays, 1000);


/* ================================
   THREE.JS SETUP
================================ */
const renderer = new THREE.WebGLRenderer({
    canvas: document.getElementById("canvas"),
    antialias: true,
    alpha: true
});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 1000);
camera.position.z = 120;

scene.add(new THREE.AmbientLight(0x333333));

const light = new THREE.PointLight(0xffffff, 2);
light.position.set(40, 40, 40);
scene.add(light);


/* ================================
   HEART SHAPE
================================ */
function makeHeart(scale) {
    const s = new THREE.Shape();
    s.moveTo(5,5);
    s.bezierCurveTo(5,5,4,0,0,0);
    s.bezierCurveTo(-6,0,-6,7,-6,7);
    s.bezierCurveTo(-6,11,-3,15.4,5,19);
    s.bezierCurveTo(12,15.4,16,11,16,7);
    s.bezierCurveTo(16,7,16,0,10,0);
    s.bezierCurveTo(7,0,5,5,5,5);

    const geo = new THREE.ExtrudeGeometry(s,{
        depth:3,
        bevelEnabled:true,
        bevelSize:0.7,
        bevelThickness:0.7
    });

    geo.scale(scale, scale, scale*0.5);
    geo.center();
    return geo;
}

/* BIG HEART */
const bigHeart = new THREE.Mesh(
    makeHeart(3.3),
    new THREE.MeshStandardMaterial({
        color:0xff4081,
        emissive:0xff1f7a,
        emissiveIntensity:0.9
    })
);
bigHeart.rotation.set(9.5, Math.PI, 0);
scene.add(bigHeart);


/* ================================
   SATELLITE HEARTS
================================ */
let notes = [];

/* Load note t·ª´ backend */
async function loadNotes() {
    const res = await fetch("http://localhost:3000/notes"); // s·ª≠a URL khi deploy
    notes = await res.json();
    notes.forEach(n => createSatellite(n));
}
loadNotes();


/* T·∫°o tr√°i tim nh·ªè */
let satellites = [];

function createSatellite(note) {
    let geo = makeHeart(0.7);

    let color = note.mood === "buon" ? 0x7ab8ff : 0xff8aa0;
    let glow  = note.mood === "buon" ? 0x2f90ff : 0xff4d6d;

    let mesh = new THREE.Mesh(
        geo,
        new THREE.MeshStandardMaterial({
            color,
            emissive:glow,
            emissiveIntensity: note.mood === "buon" ? 0.3 : 0.9
        })
    );

    mesh.rotation.set(9.5, Math.PI, 0);

    mesh.userData = {
        text: note.text,
        img: note.img,
        mood: note.mood,
        r: 65 + Math.random()*25,
        speed: 0.004 + Math.random()*0.008,
        angle: Math.random()*Math.PI*2
    };

    satellites.push(mesh);
    scene.add(mesh);
}


/* ================================
   CLICK ‚Üí SHOW POPUP
================================ */
const ray = new THREE.Raycaster();
const mouse = new THREE.Vector2();

addEventListener("click", e => {
    if (e.target.closest("#addBox")) return;
    mouse.x = (e.clientX/innerWidth)*2 - 1;
    mouse.y = -(e.clientY/innerHeight)*2 + 1;

    ray.setFromCamera(mouse, camera);
    let hit = ray.intersectObjects(satellites);

    if (hit.length) showNotePopup(hit[0].object.userData);
});

function showNotePopup(d) {
    let box = document.getElementById("popup-content");
    let moodClass = d.mood === "buon" ? "buon" : "vui";

    if (d.img) {
        box.innerHTML = `
            <div class="note-letter">
                <img class="note-img" src="${d.img}">
                <div class="note-paper ${moodClass}">${d.text}</div>
            </div>
        `;
    } else {
        box.innerHTML = `
            <div class="note-paper ${moodClass} center-note">${d.text}</div>
        `;
    }

    popup.style.display = "flex";
}


/* ================================
   ADD NOTE (L∆∞u backend)
================================ */
addBtn.onclick = () => addPopup.style.display = "flex";

async function addNote() {
    const text = noteText.value;
    const file = noteImg.files[0];
    const mood = document.querySelector("input[name='mood']:checked").value;

    if (!text.trim() && !file) {
        alert("Nh·∫≠p n·ªôi dung ho·∫∑c ·∫£nh!");
        return;
    }

    let imgBase64 = null;

    if (file) {
        imgBase64 = await new Promise(resolve => {
            let r = new FileReader();
            r.onload = () => resolve(r.result);
            r.readAsDataURL(file);
        });
    }

    let note = { text, img: imgBase64, mood, createdAt: Date.now() };

    /* G·ª≠i backend l∆∞u MongoDB */
    await fetch("http://localhost:3000/addNote", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(note)
    });

    /* T·∫°o v·ªá tinh ngay */
    createSatellite(note);

    addPopup.style.display = "none";
    noteText.value = "";
    noteImg.value = "";
}


/* ================================
   ANIMATION LOOP
================================ */
function animate() {
    requestAnimationFrame(animate);

    bigHeart.rotation.y += 0.005;

    satellites.forEach(s => {
        s.userData.angle += s.userData.speed;

        s.position.set(
            Math.cos(s.userData.angle) * s.userData.r,
            Math.sin(s.userData.angle * 0.6) * 25,
            Math.sin(s.userData.angle) * s.userData.r
        );

        s.rotation.y += 0.03;
    });

    renderer.render(scene, camera);
}
animate();


/* RESIZE */
addEventListener("resize", () => {
    renderer.setSize(innerWidth, innerHeight);
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
});
</script>

</body>
</html>
